<?php

/**
 * @file
 * Module that displays a table of characters with their data
 * for the current logged in account.
 */

/**
 * Implements hook_menu().
 */
function wowcharacters_menu() {
  $items['account/mychars'] = array(
    'title' => 'My Characters',
    'description' => 'wowitems description',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('wowcharacters_page'),
    'access callback' => 'user_is_logged_in',
    'access arguments' => array('access content'),
    'menu_name' => 'main-menu',
  );
  return $items;
}

/**
 * Helper function / Return the current logged in user username.
 * @global type $user
 * @return type
 */
function get_logged_in_username() {
  global $user;
  return $user->name;
}

/**
 * Returns the wow account for the specified username
 * @param type $username
 */
function get_wow_account_for_username($username) {

  db_set_active('auth');
  $result = db_query('SELECT * FROM `account`  WHERE username = :username', array(':username' => $username));
  db_set_active('default');
  if ($result) {
    return $result->fetchObject();
  }
  return null;
}

function get_wow_characters_for_account($account) {

  if ($account) {
    db_set_active('characters');
    $result = db_query('SELECT * FROM `characters` WHERE account =:account', array(':account' => $account->id));
    db_set_active('default');


    return $result->fetchAll();
  }
  return null;
}

/**
 * Buil ......................................
 */
function wowcharacters_page() {

  $username = get_logged_in_username();
  $account = get_wow_account_for_username($username);
  $characters = get_wow_characters_for_account($account);

  $all_character_table_columns = [
    'guid', 'account', 'name', 'race', 'class', 'gender', 'level', 'xp', 'money', 'playerBytes', 'playerBytes2',
    'playerFlags', 'position_x', 'position_y', 'position_z', 'map', 'instance_id', 'instance_mode_mask',
    'orientation', 'taximask', 'online', 'cinematic', 'totaltime', 'leveltime', 'logout_time',
    'is_logout_resting', 'rest_bonus', 'resettalents_cost', 'resettalents_time', 'trans_x',
    'trans_y', 'trans_z', 'trans_o', 'transguid', 'extra_flags', 'stable_slots', 'at_login',
    'zone', 'death_expire_time', 'taxi_path', 'arenaPoints', 'totalHonorPoints', 'todayHonorPoints',
    'yesterdayHonorPoints', 'totalKills', 'todayKills', 'yesterdayKills', 'chosenTitle',
    'knownCurrencies', 'watchedFaction', 'drunk', 'health', 'power1', 'power2', 'power3',
    'power4', 'power5', 'power6', 'power7', 'latency', 'talentGroupsCount', 'activeTalentGroup',
    'exploredZones', 'equipmentCache', 'ammoId', 'knownTitles', 'actionBars',
    'grantableLevels', 'deleteInfos_Account', 'deleteInfos_Name', 'deleteDate',
  ];
  $character_table_columns = [
//    'guid', 'account', 
    'name', 'race', 'class',
//    'gender', 
    'level',
//    'xp', 'money',
//    'playerFlags',
    'instance_id',
//    'orientation',
    'online',
    'zone', 'death_expire_time',
    'taxi_path',
    'arenaPoints',
    'totalHonorPoints',
    'todayHonorPoints',
    'yesterdayHonorPoints', 'totalKills',
    'todayKills', 'yesterdayKills', 'chosenTitle',
    'knownCurrencies',
    'health', 'power1', 'power2', 'power3',
    'power4', 'power5', 'power6', 'power7', 'latency',
    'talentGroupsCount',
    'activeTalentGroup',
  ];

  db_set_active('characters');
  echo '<div class="tablewow">';
  echo '<table class="wowstuff">';
  echo '<h3> WoW Accounts </h3>';
  echo '<tr>';
  foreach ($character_table_columns as $columnName) {
    echo'<td>';
    echo $columnName;
    echo'</td>';
  }
  echo '</tr>';
  if (count($characters) > 0) {
    foreach ($characters as $result) {
      echo '<tr>';
      foreach ($character_table_columns as $columnName) {
        echo'<td>';
        echo $result->$columnName;
        echo'</td>';
      }
    }
  }
  echo '</table>';
  echo '</div>';
  db_set_active('default');
}

/*
 * Implementation of hook_views_api()
 */

function wowcharacters_views_api() {
  return array('api' => 3.0);
}

/*
 * Implements hook_views_data_alter.
 */

function wowcharacters_views_data_alter(&$data) {



  //one account can have many characters => character = node_revision
  //one node can have multiple revisions =>  account = node


  $data['account']['table']['group'] = t('Wowacc');   // Advertise this table as a possible base table 
  $data['account']['table']['base'] = array(
    'field' => 'id',
    'title' => t('Account'),
    'weight' => -10,
    'access query tag' => 'node_access',
    'database' => 'auth',
    'defaults' => array('field' => 'username',
    ),
  );
// For other base tables, explain how we join 
  $data['account']['table']['join'] = array(
    // this explains how the 'node' table (named in the line above) 
    // links toward the node_revision table.
    'characters' => array(
      'handler' => 'views_join',
      'database' => 'characters',
      // this is actually optional 
      'left_table' => 'characters',
// Because this is a direct link it could be left out.
      'left_field' => 'account',
      'field' => 'account',
// also supported: // 'type' => 'INNER',
    // 'extra' => array(array('field' => 'fieldname', 'value' => 'value', 'operator' => '=')) 
// Unfortunately, you can't specify other tables here, but you can construct 
// alternative joins in the handlers that can do that. 
// 'table' => 'the actual name of this table in the database',
    ),
  );


  // ---------------------------------------------------------------- 
// node table -- fields // title 
// This definition has more items in it than it needs to as an example. 
  $data['account']['username'] = array(
    'title' => t('Username'), // The item it appears as on the UI, 
    'help' => t('The account username.'), // The help that appears on the UI, 
// Information for displaying a title as a field
    'field' => array(
      'field' => 'username', //   the real field. This could be left out since it is the same. 
      'group' => t('Wowacc'), // The group it appears in on the UI. Could be left out.
      'handler' => 'views_handler_field',
      'click sortable' => TRUE,
//      'link_to_node default' => TRUE,
    ),
    'sort' => array(
      'handler' => 'views_handler_sort',
    ),
// Information for accepting a title as a filter 
    'filter' => array(
      'handler' => 'views_handler_filter_string',
    ),
    'argument' => array(
      'handler' => 'views_handler_argument_string',
    ),
  );

//  $data['account']['characters'] = array(
//    'title' => t('Characters'), // The item it appears as on the UI, 
//    'help' => t('The account characters.'), // The help that appears on the UI, 
//    'database' => 'characters',
//// Information for displaying a title as a field
//    'field' => array(
//      'field' => 'characters', //   the real field. This could be left out since it is the same. 
//      'group' => t('Wowacc'), // The group it appears in on the UI. Could be left out.
//      'handler' => 'views_handler_field',
//      'click sortable' => TRUE,
////      'link_to_node default' => TRUE,
//    ),
//    'sort' => array(
//      'handler' => 'views_handler_sort',
//    ),
//// Information for accepting a title as a filter 
//    'filter' => array(
//      'handler' => 'views_handler_filter_string',
//    ),
//    'argument' => array(
//      'handler' => 'views_handler_argument_string',
//    ),
//  );



  //  dpm('Chars');
//  dpm($data['account']);
//  dpm($data['characters']);
////  dpm('Account');
}

//function wowcharacters_views_data_alter(&$data) {
//
//  //Define the base group of this table.
//  //Fields that don't have a group defined will go into this field by default.
//  $data['characters']['table']['group'] = t('Characters');
//  //Advertise this table as a possible base table.
//  $data['characters']['table']['base'] = array(
//    'field' => 'guid',
//    'title' => t('Character'),
//    'weight' => -10,
//    'acces query tag' => 'node_access',
//    'database' => 'characters',
//    'defaults' => array(
//      'field' => 'id',
//    )
//  );
//  // For other base tables, explain how we join
//  $data['characters']['table']['join'] = array(
//    //this explains how the 'characters' table links towards the account table.
//    'account' => array(
//      'handler' => 'views_join',
//      'left_table' => 'account',
//      'left_field' => 'id',
//      'field' => 'id',
//    ),
//  );
//  //account table -- fields
//  // username
//  $data['account']['id'] = array(
//    'title' => t('id field'), //The item it appears as on the UI,
//    'help' => t('Account id '), //The help that appears on the UI
//    'field' => array(
////      'field' => 'username',
////      'group' => t('Characters'),
//      'handler' => 'views_handler_field_numeric',
//      'database' => 'auth',
//      'click sortable' => TRUE,
//    ),
//    'sort' => array(
//      'handler' => 'views_handler_sort',
//    ),
//    //Information for accepting a username as a filter
//    'filter' => array(
//      'handler' => 'views_handler_filter_numeric',
//    ),
//  );
//
//
////  dpm('Chars');
//  dpm($data['characters']);
////  dpm('Account');
//  dpm($data['account']);
////  die('dead in hook data alter');
//}
